<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Snow Day Probability</h1>
    <div id="snow-day-results"></div>
    <script type="text/javascript">
        const API_KEY = 'a566780b5f734e56b08161831243009';
        
        async function fetchWeatherForecast(location) {
            try {
                const response = await fetch(
                    `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${location}&days=7&aqi=no`
                );
                const data = await response.json();

                console.log(data);
                return data;
            } catch (error) {
                console.error('Error fetching weather data:', error);
                return null;
            }
        }

        async function displaySnowDayProbabilities(location) {
            const weatherData = await fetchWeatherForecast(location);
            if (!weatherData) return;

            const priorSnowDays = parseInt(document.getElementById('prior-snow-days-input').value) || 0;
            const resultDiv = document.createElement('div');
            resultDiv.id = 'snow-day-results';

            weatherData.forecast.forecastday.forEach(day => {
                const forecast = {
                    daily_will_it_snow: day.day.daily_will_it_snow,
                    daily_chance_of_snow: day.day.daily_chance_of_snow,
                    daily_chance_of_rain: day.day.daily_chance_of_rain,
                    totalsnow_cm: day.day.totalsnow_cm,
                    mintemp_f: day.day.mintemp_f,
                    avgtemp_f: day.day.avgtemp_f,
                    avgvis_miles: day.day.avgvis_miles
                };

                const date = new Date(day.date);
                const snowDayPercentage = calculateSnowDayProbabilityPercentage(
                    forecast,
                    priorSnowDays,
                    exampleWeights
                );

                const dayResult = document.createElement('p');
                dayResult.textContent = `${date.toLocaleDateString()}: Snow Day Probability: ${snowDayPercentage.toFixed(2)}%`;
                resultDiv.appendChild(dayResult);
            });

            // Remove existing results if any
            const existingResults = document.getElementById('snow-day-results');
            if (existingResults) {
                existingResults.remove();
            }
            document.body.appendChild(resultDiv);
        }

        // Add location input and button
        const locationInput = document.createElement('input');
        locationInput.type = 'text';
        locationInput.placeholder = 'Enter location (e.g., London)';
        locationInput.id = 'location-input';
        
        // Add prior snow days input
        const priorSnowDaysInput = document.createElement('input');
        priorSnowDaysInput.type = 'number';
        priorSnowDaysInput.min = '0';
        priorSnowDaysInput.placeholder = 'Number of prior snow days';
        priorSnowDaysInput.id = 'prior-snow-days-input';
        
        const checkButton = document.createElement('button');
        checkButton.textContent = 'Check Snow Probability';
        checkButton.onclick = () => displaySnowDayProbabilities(locationInput.value);

        document.body.insertBefore(locationInput, document.body.firstChild);
        document.body.insertBefore(priorSnowDaysInput, locationInput.nextSibling);
        document.body.insertBefore(checkButton, priorSnowDaysInput.nextSibling);

        /**
     * Calculates the probability of a snow day based on various weather and historical factors and returns it as a percentage.
     *
     * @param {Object} forecast - The forecast data object for a given day. 
     *                            Expected fields from your weather API:
     *                              daily_will_it_snow (int: 0 or 1)
     *                              daily_chance_of_snow (int: 0-100)
     *                              daily_chance_of_rain (int: 0-100)
     *                              totalsnow_cm (decimal)
     *                              mintemp_f (decimal)
     *                              avgtemp_f (decimal)
     *                              avgvis_miles (decimal)
     *
     * @param {number} priorSnowDays - Number of prior snow days entered by the user.
     *
     * @param {Object} weights - An object containing configurable weights for each factor:
     *                           {
     *                              alpha: number   // weight for daily_will_it_snow
     *                              beta: number    // weight for daily_chance_of_snow
     *                              gamma: number   // weight for totalsnow_cm
     *                              delta: number   // weight for temp factor
     *                              epsilon: number // weight for visibility factor
     *                              zeta: number    // weight for prior snow days factor
     *                              eta: number     // weight for rain chance factor
     *                              theta: number   // weight for warmth factor
     *                           }
     *
     * @return {number} Returns the probability as a percentage (0 to 100).
     *
     * Note:
     * - The underlying logic still uses a logistic function. The logistic output is in [0,1].
     * - We convert that to a percentage by multiplying by 100.
     */
            function calculateSnowDayProbabilityPercentage(forecast, priorSnowDays, weights) {
                const {
                    daily_will_it_snow,
                    daily_chance_of_snow,
                    daily_chance_of_rain,
                    totalsnow_cm,
                    mintemp_f,
                    avgtemp_f,
                    avgvis_miles
                } = forecast;

                const {
                    alpha = 1.0,
                    beta = 0.8,
                    gamma = 0.2,
                    delta = 1.0,
                    epsilon = 1.0,
                    zeta = 0.5,
                    eta = 0.3,
                    theta = 0.2
                } = weights || {};

                // Calculate individual factor contributions to the score:
                const snowBinaryFactor = alpha * daily_will_it_snow;
                const snowChanceFactor = beta * (daily_chance_of_snow / 100);
                const snowAmountFactor = gamma * totalsnow_cm;
                const tempFactor = delta * Math.max(0, (32 - mintemp_f) / 32);
                const visFactor = epsilon * (1 - (avgvis_miles / 10));
                const priorFactor = zeta * (priorSnowDays / 5);
                const rainFactor = -eta * (daily_chance_of_rain / 100);
                const warmthFactor = -theta * (avgtemp_f / 50);

                // Sum all factors to get a raw score (Z)
                const Z = snowBinaryFactor
                    + snowChanceFactor
                    + snowAmountFactor
                    + tempFactor
                    + visFactor
                    + priorFactor
                    + rainFactor
                    + warmthFactor;

                // Convert the score Z into a probability using the logistic function
                const probability = 1 / (1 + Math.exp(-Z));

                // Convert the probability (0-1) into a percentage (0-100%)
                const percentage = probability * 100;

                return percentage;
            }

            // Example usage:
            const exampleForecast = {
                daily_will_it_snow: 1,
                daily_chance_of_snow: 80,
                daily_chance_of_rain: 20,
                totalsnow_cm: 5,
                mintemp_f: 20,
                avgtemp_f: 30,
                avgvis_miles: 6
            };

            const exampleWeights = {
                alpha: 1.0,
                beta: 0.8,
                gamma: 0.2,
                delta: 1.0,
                epsilon: 1.0,
                zeta: 0.5,
                eta: 0.3,
                theta: 0.2
            };
    </script>
</body>
</html>